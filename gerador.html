<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Gerador Tio Jonas V2</title>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f6f8; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; text-align: center; }
        .import-area { background: #e8f5e9; border: 2px dashed #2ecc71; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        textarea { width: 100%; height: 60px; padding: 10px; border: 1px solid #ccc; font-family: monospace; }
        .row { display: flex; gap: 15px; margin-top: 10px; }
        .col { flex: 1; }
        label { display: block; font-size: 13px; font-weight: bold; color: #555; }
        input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        input:focus { border-color: #2980b9; outline: none; background: #f0f8ff; } /* Real√ßa quando voc√™ clica para editar */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; }
        .btn-green { background-color: #27ae60; }
        .btn-blue { background-color: #2980b9; font-size: 18px; margin-top: 30px; }
        .calc-box { background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeeba; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üöê Sistema Tio Jonas V2</h1>

        <div style="text-align:center; margin-bottom:20px;">
            <label style="cursor: pointer; color: #856404; background:#fff3cd; padding:10px; border-radius:5px;">
                üìÇ 1¬∫ PASSO: Selecionar PDF Modelo
                <input type="file" id="pdfModelo" accept="application/pdf" style="display: none;">
            </label>
            <div id="nomeArquivo" style="margin-top:5px; font-size:12px;">Nenhum arquivo</div>
        </div>

        <div class="import-area">
            <h3>üì≤ 2¬∫ PASSO: Colar dados do Zap</h3>
            <textarea id="codigoPais" placeholder='Cole a mensagem aqui...'></textarea>
            <button class="btn btn-green" onclick="carregarDadosZap()">‚¨áÔ∏è Puxar Dados</button>
        </div>

        <form id="formContrato">
            <h3>üë§ Dados Pessoais (Edit√°veis)</h3>
            <p style="font-size:12px; color:#666;">*Se tiver erro de portugu√™s, corrija nos campos abaixo antes de gerar.</p>
            
            <div class="row">
                <div class="col"><label>Nome Pai/M√£e</label><input type="text" id="cliente_nome"></div>
                <div class="col"><label>CPF</label><input type="text" id="cliente_cpf"></div>
            </div>
            <div class="row">
                <div class="col"><label>RG</label><input type="text" id="cliente_rg"></div>
                <div class="col"><label>Endere√ßo</label><input type="text" id="cliente_endereco"></div>
            </div>
            <div class="row">
                <div class="col"><label>Tel 1</label><input type="text" id="cliente_telefone"></div>
                <div class="col"><label>Tel 2</label><input type="text" id="cliente_telefone_2"></div>
            </div>

            <h3>üéì Alunos</h3>
            <div class="row">
                <div class="col"><label>Aluno 1</label><input type="text" id="aluno_nome_1"></div>
                <div class="col"><label>Aluno 2</label><input type="text" id="aluno_nome_2"></div>
            </div>
            <div class="row">
                <div class="col"><label>Escola</label><input type="text" id="escola_nome"></div>
                <div class="col"><label>Hor√°rio</label><input type="text" id="escola_horario"></div>
            </div>

            <div class="calc-box">
                <h3>üí∞ Financeiro (Autom√°tico)</h3>
                <div class="row">
                    <div class="col">
                        <label>Valor Total do Contrato (R$)</label>
                        <input type="number" id="valor_total" placeholder="Ex: 3000" oninput="calcularMensal()">
                    </div>
                    <div class="col">
                        <label>Qtd Parcelas</label>
                        <input type="number" id="qtd_parcelas" value="12" oninput="calcularMensal()">
                    </div>
                    <div class="col">
                        <label>Valor Mensal (Calculado)</label>
                        <input type="text" id="valor_mensal" readonly style="background: #eee; font-weight:bold;">
                    </div>
                </div>
                <div class="row">
                    <div class="col"><label>Dia Vencimento</label><input type="number" id="dia_vencimento" value="10"></div>
                    <div class="col"><label>Multa</label><input type="text" id="multa_atraso" value="2%"></div>
                </div>
            </div>

            <button class="btn btn-blue" type="button" onclick="gerarPDF()">üìÑ Gerar Contrato Final</button>
        </form>
    </div>

    <script>
        // Visual arquivo
        document.getElementById('pdfModelo').addEventListener('change', function(e) {
            if(e.target.files[0]) {
                document.getElementById('nomeArquivo').innerHTML = `‚úÖ ${e.target.files[0].name}`;
                document.getElementById('nomeArquivo').style.color = "green";
            }
        });

        // --- CALCULADORA FINANCEIRA ---
        function calcularMensal() {
            const total = parseFloat(document.getElementById('valor_total').value);
            const parcelas = parseFloat(document.getElementById('qtd_parcelas').value);

            if (total && parcelas) {
                const mensal = total / parcelas;
                // Formata para dinheiro bonito (Ex: 250,00)
                document.getElementById('valor_mensal').value = mensal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                document.getElementById('valor_mensal').value = "";
            }
        }

        // --- PUXAR DADOS BLINDADO ---
        function carregarDadosZap() {
            try {
                let texto = document.getElementById('codigoPais').value;
                texto = texto.replace(/[\u201C\u201D\u201E\u201F\u2033\u2036]/g, '"').replace(/(\r\n|\n|\r)/gm, " ");
                
                const inicio = texto.indexOf('{');
                const fim = texto.lastIndexOf('}');
                
                if (inicio === -1) { alert("Cole o c√≥digo completo com { }"); return; }
                
                const jsonLimpo = texto.substring(inicio, fim + 1);
                let dados;
                try { dados = JSON.parse(jsonLimpo); } 
                catch (e) { dados = JSON.parse(decodeURIComponent(jsonLimpo)); }

                const set = (id, val) => document.getElementById(id).value = val || "";
                
                set('cliente_nome', dados.cliente_nome);
                set('cliente_cpf', dados.cliente_cpf);
                set('cliente_rg', dados.cliente_rg);
                set('cliente_endereco', dados.cliente_endereco);
                set('cliente_telefone', dados.cliente_telefone);
                set('cliente_telefone_2', dados.cliente_telefone_2);
                set('aluno_nome_1', dados.aluno_nome_1);
                set('aluno_nome_2', dados.aluno_nome_2);
                set('escola_nome', dados.escola_nome);
                set('escola_horario', dados.escola_horario);

                alert("‚úÖ Dados carregados! Corrija se necess√°rio e preencha o financeiro.");

            } catch (e) { alert("Erro ao ler dados."); }
        }

        // --- GERAR PDF ---
        async function gerarPDF() {
            const fileInput = document.getElementById('pdfModelo');
            if (fileInput.files.length === 0) { alert("Selecione o PDF!"); return; }

            try {
                const arrayBuffer = await fileInput.files[0].arrayBuffer();
                const { PDFDocument } = PDFLib;
                const pdfDoc = await PDFDocument.load(arrayBuffer);
                const form = pdfDoc.getForm();

                const preencher = (nomePDF, idHTML) => {
                    try {
                        const valor = document.getElementById(idHTML).value;
                        form.getTextField(nomePDF).setText(valor);
                    } catch (e) {}
                };

                // SEUS MAPEAMENTOS DEFINITIVOS
                preencher('Text1', 'cliente_nome');
                preencher('Text3', 'cliente_cpf');
                preencher('Text4', 'cliente_rg');
                preencher('Text5', 'cliente_endereco');
                preencher('Text6', 'cliente_telefone');
                preencher('Text7', 'cliente_telefone_2');

                preencher('Text8', 'aluno_nome_1');
                preencher('Text9', 'aluno_nome_2');
                preencher('Text11', 'escola_nome');
                preencher('Text12', 'escola_horario');

                preencher('Text18', 'valor_total');
                preencher('Text19', 'valor_mensal');
                preencher('Text22', 'multa_atraso');
                preencher('Text20', 'qtd_parcelas'); 
                preencher('Text21', 'dia_vencimento'); 

                // TIO JONAS
                try {
                    form.getTextField('Text13').setText('Tio Jonas Transportes');
                    form.getTextField('Text14').setText('000.000.000-00');
                    form.getTextField('Text15').setText('SSP/DF');
                    form.getTextField('Text16').setText('Planaltina, DF');
                    form.getTextField('Text17').setText('(61) 99999-9999');
                } catch(e) {}

                // DATAS
                const hoje = new Date();
                const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                try { form.getTextField('data_dia').setText(hoje.getDate().toString()); } catch(e){}
                try { form.getTextField('data_mes').setText(meses[hoje.getMonth()]); } catch(e){}
                try { form.getTextField('data_ano').setText("26"); } catch(e){}

                form.flatten();
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const nomeCli = document.getElementById('cliente_nome').value || "Contrato";
                link.download = `Contrato_${nomeCli}.pdf`;
                link.click();

            } catch (erro) { alert("Erro ao gerar PDF: " + erro.message); }
        }
    </script>
</body>
</html>